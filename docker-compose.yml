#######################
#   REQUIRED ENV:     #
#   - MANAGER_HOST    #
#   - CATCHALL_HOST   #
#######################

services:
  # URL: https://${CATCHALL_HOST}
  web:
    image: nginx:alpine
    container_name: catchall-host
    restart: unless-stopped
    volumes:
      - /opt/docker_volumes/catchall/data/caught:/usr/share/nginx/html:ro      # nginx file access
    command: >
      /bin/sh -c "wget -q https://raw.githubusercontent.com/ww-bay/catchall/main/conf/default.conf -O /etc/nginx/conf.d/default.conf &&
      exec nginx -s reload"
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      # HTTP -> HTTPS Redirect
      - "traefik.http.routers.catchall.entrypoints=http"
      - "traefik.http.routers.catchall.rule=Host(`${CATCHALL_HOST}`)"
      - "traefik.http.middlewares.catchall-https.redirectscheme.scheme=https"
      - "traefik.http.routers.catchall.middlewares=catchall-https"
      # HTTPS Router
      - "traefik.http.routers.catchall-secure.entrypoints=https"
      - "traefik.http.routers.catchall-secure.rule=Host(`${CATCHALL_HOST}`)"
      - "traefik.http.routers.catchall-secure.tls=true"
      - "traefik.http.services.catchall.loadbalancer.server.port=80" # Nginx internal port
      - "traefik.docker.network=proxy"

  # URL: https://${MANAGER_HOST}/
  files:
    image: filebrowser/filebrowser:s6
    container_name: catchall-manager
    restart: unless-stopped
    volumes:
      - /opt/docker_volumes/catchall/data/caught:/srv                   # filebrowser file access
      - /opt/docker_volumes/catchall/data/filebrowser:/config
      - /opt/docker_volumes/catchall/data/filebrowser:/database                                # filebrowser database
    environment:
      - PUID=$(id -u)
      - PGID=$(id -g)
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      # HTTP -> HTTPS Redirect
      - "traefik.http.routers.filebrowser.entrypoints=http"
      - "traefik.http.routers.filebrowser.rule=Host(`${MANAGER_HOST}`)"
      - "traefik.http.middlewares.fb-https.redirectscheme.scheme=https"
      - "traefik.http.routers.filebrowser.middlewares=fb-https"
      # HTTPS Router
      - "traefik.http.routers.filebrowser-secure.entrypoints=https"
      - "traefik.http.routers.filebrowser-secure.rule=Host(`${MANAGER_HOST}`)"
      - "traefik.http.routers.filebrowser-secure.tls=true"
      - "traefik.http.services.filebrowser.loadbalancer.server.port=80" # FileBrowser internal port
      - "traefik.docker.network=proxy"

networks:
  proxy:
    external: true